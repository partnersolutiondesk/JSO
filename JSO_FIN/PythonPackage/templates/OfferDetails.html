<!DOCTYPE html>
<html>
<head>
  <!-- Include the Vue.js and Axios CDN -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
  <div id="app">
    <h3 class="p-3 text-center">Offer Details</h3>
    <table>

        <tbody>


        <tr> <td>OTP</td>
              <td> <input type="text" ref="otp" v-model="offer.OTP" :disabled="!isEditing"
           :class="{view: !isEditing}"></td>
            </tr>

<tr> <td>First Name</td>
              <td> <input type="text" ref="last_name" v-model="offer.customerDetails.First_Name" :disabled="!isEditing"
           :class="{view: !isEditing}"></td>

            </tr>
          <tr> <td>Last Name</td>
              <td> <input type="text" ref="last_name" v-model="offer.customerDetails.Last_Name" :disabled="!isEditing"
           :class="{view: !isEditing}"></td>
            </tr>
        <tr> <td>Amount</td>
              <td> <input type="text" ref="last_name" v-model="offer.Amount" :disabled="!isEditing"
           :class="{view: !isEditing}"></td>
            </tr>
        <tr><td>----------------DEBUG-------------</td></tr>
        <tr> <td>OTP display only during development</td>
             <td> <label>[[OTPDisp]] </label></td>
            </tr>
        <tr> <td>Role of the current user</td>
             <td> <label>[[Role]] </label></td>
            </tr>
         <tr><td>----------------DEBUG-------------</td></tr>
          <tr> <td>Address</td>
              <td> <input type="text" ref="last_name" v-model="offer.customerDetails.Address" :disabled="!isEditing"
           :class="{view: !isEditing}"></td>
            </tr>
          <tr> <td>Age</td>
              <td> <input type="text" ref="last_name" v-model="offer.customerDetails.Age" :disabled="!isEditing"
           :class="{view: !isEditing}"></td>
            </tr>

                  <tr>
                <td>Type</td>
                <td> <input type="text" ref="first_name" v-model="offer.Type" :disabled="!isEditing"
           :class="{view: !isEditing}"></td></tr>
               <tr> <td>Status</td>
              <td> <input type="text" ref="last_name" v-model="offer.Status" :disabled="!isEditing"
           :class="{view: !isEditing}"></td>
            </tr>

        <tr> <td>Account</td>
              <td> <input type="text" ref="last_name" v-model="offer.Account_ID" :disabled="!isEditing"
           :class="{view: !isEditing}"></td>
            </tr>


        </tbody>
    </table>
       <button @click="isEditing = !isEditing" v-if="!isEditing">
    Edit
  </button>&nbsp;
       <button @click="ProceedWithOffer" v-if="!isEditing">
   Yes, I am interested1
  </button>&nbsp;
      <button @click="OTPLogin" v-if="OTPSend">
   Validate OTP
  </button>&nbsp;
      <button @click="NotInterested" v-if="!isEditing">
   No, I am not interested
  </button>
  <button @click="editSave" v-else-if="isEditing">
  Save
  </button>

  <button v-if="isEditing" @click="isEditing = false">Cancel</button>


      <table height="100">
        <tbody>
         <tr><td>----------------EXCEPTIONAL CASES-------------</td></tr>
         <tr><td>
                <button @click="NoActionMidWayReminder" v-else-if="isEditing">No action/Mid way - Reminder</button>
         </td></tr>


        </tbody>
      </table>


        <table height="100">
        <tbody>
         <tr><td>----------------AUDIT TRAIL SUMMARY-------------</td></tr>
         <tr><td>
                <button @click="auditTrailSummary" v-else-if="isEditing">Audit Trail Summary</button>
         </td></tr>


        </tbody>
      </table>

</div>
  <script>
    // Create a new Vue instance
      const urlParams = new URLSearchParams(window.location.search);
      const offerID = urlParams.get('id');
      console.log("custID"+offerID)
      const app = Vue.createApp({

        data() {

        return {
          isEditing:false,
          offer: {"Type":"Loan"
          ,"Status":"New",
          "Account_ID":"23243",
          "Amount":1000,
          "OTP":111111,
          "customerDetails":{
          "First_Name":"adad",
          "Last_Name":"kat",
          "Address": "",
          "Account_ID": "",
          "Age":0
          }
          },

        }
        },
        delimiters : ['[[', ']]'],
      mounted() {
        // Fetch customer data from the Flask API
        console.log("test1")
        if (offerID != null){
        axios.post('http://localhost:5000/jso/getOfferDetails',{id: offerID}).then((response) => {
            //console.log('API Response:', JSON.parse(response));
            if(response.data.OfferDetails){
            }
            //console.log(response.data.OfferDetails.OTP)
           // console.log(response.data.OfferDetails)

            this.offer = JSON.parse(response.data.OfferDetails);
            this.OTPDisp =  this.offer.OTP
            this.offer.OTP=""
            this.Role=response.data.Role
            console.log(this.offer)
            //console.log(this.offer.customerDetails.First_Name)
            this.isEditing=false;
            if (this.offer.OTPDisp !=""){
               this.OTPSend = 1
               }
          })
          .catch((error) => {
            console.error('Error fetching customer data:', error);
          });
          }
      },
      methods:{
        editSave(customerID){
            //if (offerID ==""){
             axios.post('http://localhost:5000/jso/saveOfferDetails',{data:this.offer}).then((response) => {
            //console.log('API Response:', JSON.parse(response));
            //this.customer = JSON.parse(response.data.CustomerDetails);
            this.isEditing=false;
          })
          .catch((error) => {
            console.error('Error fetching customer data:', error);
          });
        },
        auditTrailSummary(){
             axios.post('http://localhost:5000/jso/DeployNoActionOrMidwayMail',{type: "midway",inputs : "Offer Status :  "+offerDetails.StatusText +", LastModified : "+offerDetails.LastModified.$date + ", CreatedOn : "+offerDetails.CreatedOn.$date+ ", ValidityInDays : "+offerDetails.ValidityInDays  }).then((response) => {
                 });
        },
        NoActionMidWayReminder(){
         axios.post('http://localhost:5000/jso/getOfferStatus',{id: offerID}).then((response) => {
             console.log(response)
            //compare the Dates
            console.log(JSON.parse(response.data.offerDetails).Status)
            offerDetails = JSON.parse(response.data.offerDetails)
            if(offerDetails.Status < 80 && offerDetails.Status > 20){
                alert("This offer left mid-way by the customer. \n \n  Please find the offer Details below,\n Offer Status :  "+offerDetails.StatusText +", \n LastModified : "+offerDetails.LastModified.$date + ", \n CreatedOn : "+offerDetails.CreatedOn.$date+ ", \n ValidityInDays : "+offerDetails.ValidityInDays + "\n \n Please check your email for the sample Email")
                 axios.post('http://localhost:5000/jso/DeployNoActionOrMidwayMail',{type: "midway",inputs : "Offer Status :  "+offerDetails.StatusText +", LastModified : "+offerDetails.LastModified.$date + ", CreatedOn : "+offerDetails.CreatedOn.$date+ ", ValidityInDays : "+offerDetails.ValidityInDays  }).then((response) => {
                 });
            }
             if(offerDetails.Status < 30){
                alert("No action on this offer by the customer. \n \n Please find the offer Details below,\n Offer Status :  "+offerDetails.StatusText +", \n LastModified : "+offerDetails.LastModified.$date + ", \n CreatedOn : "+offerDetails.CreatedOn.$date+ ", \n ValidityInDays : "+offerDetails.ValidityInDays + "\n \n Please check your email for the sample Email")
                 axios.post('http://localhost:5000/jso/DeployNoActionOrMidwayMail',{type: "noaction", inputs : "Offer Status :  "+offerDetails.StatusText +", LastModified : "+offerDetails.LastModified.$date + ", CreatedOn : "+offerDetails.CreatedOn.$date+ ", ValidityInDays : "+offerDetails.ValidityInDays}).then((response) => {
                 });
            }
          })
          .catch((error) => {
            console.error('Error fetching customer data:', error);
          });

        },
        sendOTP(customerID){
            //if (offerID ==""){
             axios.post('http://localhost:5000/jso/sendOTP',{data:this.offer}).then((response) => {
             console.log(response.data.status)
             //console.log('API Response:', JSON.parse(response));
            //this.customer = JSON.parse(response.data.CustomerDetails);
            this.OTPDisp = response.data.status.otp
            this.isEditing=false;
          })
          .catch((error) => {
            console.error('Error fetching customer data:', error);
          });
        },
           ProceedWithOffer(){
            axios.post('http://localhost:5000/jso/ProceedWithOffer',{"offerID":offerID}).then((response) => {
             console.log(response)
             if (response.data.status == "FAIL"){
              alert("something went wrong!")
             }
             else if  (response.data.status == "Thanks for choosing the offer. You will get a notification soon"){
              alert("Thank you for selecting this offer. You will receive an OTP shortly. Please input the OTP here to continue.");
             }
            this.isEditing=false;
          })
          .catch((error) => {
            console.error('Error fetching customer data:', error);
          });
         },
           NotInterested(){
            axios.post('http://localhost:5000/jso/NotInterested',{"offerID":offerID}).then((response) => {
             console.log(response)
             if (response.data.status == "FAIL"){
              alert("something went wrong!")
             }
             else if  (response.data.status == "Thanks for your update"){
              alert(response.data.status);
             }
            this.isEditing=false;
          })
          .catch((error) => {
            console.error('Error fetching customer data:', error);
          });
         },
        OTPLogin(){

             axios.post('http://localhost:5000/jso/OTPlogin',{"otp":this.offer.OTP,"offerID":offerID}).then((response) => {
             console.log(response)
             if (response.data.status == "FAIL"){
              alert("OTP Validation Failed")
              this.OTPVALIDATION=false;
             }
             else if  (response.data.status == "PASS"){
              alert("OTP verified. You will get the email shortly with more details.");
              this.OTPVALIDATION=true;
             }
            this.isEditing=false;
          })
          .catch((error) => {
            console.error('Error fetching customer data:', error);
          });
        }


      }
    });
    // Mount the Vue app to the element with id "app"
    app.mount('#app');
  </script>
</body>
</html>
